---
title: "(3) Uploading and Combining Death Data"
author: "Anna Stouffer"
date: "2024-05-22"
output: html_document
---

# Andrew - the purpose of this file is to upload the death data provided to me by NCDHHS. It is divided into three files, 1999-2013, 2014-2021, and 2022, with each one being formatted slightly differently (for example, ethnicity is coded differently for the first file then the second two). The output of this code should be one .csv file, where each row represents a death, and it contains all overdose deaths for 1999-2022. 

# the coding system for deaths (the first filtering part) can be kind of confusing. You can look up ICD10 codes if you want, and the url is contained in the cell where I list the codes. Basically the primary code lets you know if its an overdose, and the secondary code (which there can be multiple listed of) is the more specific cause of death. 

# also, there is a cell towards the bottom that creates a file called population_per_county_per_year which you need in the future. 

# files you need to upload to get this to work -> "2014-2021 NC Mortality.csv", "1999-2013 NC Mortality.csv", "2022 NC Mortality.csv", "NCprojectionsbyage2022.csv"

# problems -> nothing it's just not clean


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
---
title: "NC Death Analysis"
author: "annastouffer"
date: "2023-10-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load library
library(prism)
library(tigris)
library(terra)
library(stringr)
library(stars)
library(lubridate)
library(parallel)
library(data.table)
library(future.apply)
library(tidycensus)
library(tidyverse)
library(here)
library(exactextractr)
library(sjPlot)
library(wec)
library(lme4)
library(lme4)
library(sjPlot)


```


```{r}
# data with only one COD
#DEATH_DIR = ("/Users/annastouffer/Documents/Yale/Thesis/Death Data/archive/1980-2021 NC Mortality/")

# data with top three COD
DEATH_DIR2 = ("/Users/annastouffer/Documents/Yale/Thesis/Death Data/archive/1980-1921 NC MortalityV2/")

```

```{r}
# reading in data from file
# for only one COD
# death_data_all_2014 = read.csv(file.path(DEATH_DIR, "2014-2021 NC Mortality.csv"))
# death_data_all_1999 = read.csv(file.path(DEATH_DIR, "1999-2013 NC Mortality.csv"))

# for top three COD
death_data_new_2014 = read.csv(file.path(DEATH_DIR2, "2014-2021 NC Mortality.csv"))
death_data_new_1999 = read.csv(file.path(DEATH_DIR2, "1999-2013 NC Mortality.csv"))
death_data_2022 = read.csv(file.path(DEATH_DIR2, "2022 NC Mortality.csv"))
colnames(death_data_2022)[colnames(death_data_2022) == "raceethComb"] <- "raceethcomb"
death_data_new_2014 <- rbind(death_data_new_2014, death_data_2022)


unique(death_data_new_1999$race)

names(death_data_2022)
names(death_data_new_2014)

head(death_data_new_2014, 100)
### helpful notes for understanding the data
# COD = county
# race: 1 = white, 2 = black, 3 = native american, 4 = indian, 5 = chinese, 6 = filipino, 7 = japanese, 8 = korean, 9 = vietnamese, 10 = other asian, 11 = hawaiin, 12 = guamanian or chamorro, 13 = samoan, 14 = other pacific islander, 15 = other

dim(death_data_new_1999)[1]+dim(death_data_new_2014)[1]


```

```{r}
# selecting opioid related deaths
# Drug deaths are defined as ICD-10 codes X40-X44, X60-X64, X85, Y10-Y14. (https://injuryfreenc.dph.ncdhhs.gov/DataSurveillance/poisoning/SummaryTableforPoisoningDefinitions.pdf)

# gunshot codes
#number_sequences <- c("W22", "W23", "W32", "W33", "S20", "S21", "S30", "S31", "S40", "S41", "S50", "S51", "S60", "S61", "S70", "S71", "S80", "S81", "S90", "S91", "T14.90")

# car accident codes
#number_sequences <- c("V409", "V430", "V499", "V872", "V4900", "V202", "V464", "V479", "V525", "W2200", "W040")

# heart attack codes 
#number_sequences <- c("I200", "I201", "I208", "I209", "I210", "I211", "I219", "I220", "I221", "I228", "I229")

# To access the codes, you can use icd_10_codes[index]

# overdose codes
number_sequences = c("X40", "X41", "X42", "X43", "X44", "X60", "X61", "X62", "X63", "X64", "X85", "Y10", "Y11", "Y12", "Y13", "Y14")

secondary_sequences = c("T400", "T401", "T402", "T403", "T404", "T406")

cocaine_sequence = c("T405")

meth_sequence = c("T436")

# for any poisoning
#, "X45", "X46", "X47", "X48", "X49", "X65", "X66", "X67", "X68", "X69", "X85", "X85", "X87", "X88", "X89", "X90", "Y15", "Y16", "Y17", "Y18", "Y19"
```

```{r}
# # selecting overdose deaths from 2014 - 2021 data
# 
# # using grepl to create a logical vector indicating if each row contains the sequences
# matches <- grepl(paste(number_sequences, collapse = "|"), death_data_all_2014$ACMECOD)
# 
# # subset the death data frame to select rows that match the sequences
# death_data <- death_data_all_2014[matches, ]
# 
# # this shows about 20,000 overdose deaths between 2014 and 2021. 
# dim(death_data)
# head(death_data)
# length(unique(death_data$COD))
```

```{r}
# generating a list of federal holidays

# Generate federal holidays
holidays <- as.Date(c(
  # 1999
  "1999-01-01", "1999-01-18", "1999-02-15", "1999-05-31", "1999-07-04",
  "1999-09-06", "1999-10-11", "1999-11-11", "1999-11-25", "1999-12-25",
  # 2000
  "2000-01-01", "2000-01-17", "2000-02-21", "2000-05-29", "2000-07-04",
  "2000-09-04", "2000-10-09", "2000-11-11", "2000-11-23", "2000-12-25",
  # 2001
  "2001-01-01", "2001-01-15", "2001-02-19", "2001-05-28", "2001-07-04",
  "2001-09-03", "2001-10-08", "2001-11-11", "2001-11-22", "2001-12-25",
  # 2002
  "2002-01-01", "2002-01-21", "2002-02-18", "2002-05-27", "2002-07-04",
  "2002-09-02", "2002-10-14", "2002-11-11", "2002-11-28", "2002-12-25",
  # 2003
  "2003-01-01", "2003-01-20", "2003-02-17", "2003-05-26", "2003-07-04",
  "2003-09-01", "2003-10-13", "2003-11-11", "2003-11-27", "2003-12-25",
  # 2004
  "2004-01-01", "2004-01-19", "2004-02-16", "2004-05-31", "2004-07-04",
  "2004-09-06", "2004-10-11", "2004-11-11", "2004-11-25", "2004-12-25",
  # 2005
  "2005-01-01", "2005-01-17", "2005-02-21", "2005-05-30", "2005-07-04",
  "2005-09-05", "2005-10-10", "2005-11-11", "2005-11-24", "2005-12-25",
  # 2006
  "2006-01-01", "2006-01-16", "2006-02-20", "2006-05-29", "2006-07-04",
  "2006-09-04", "2006-10-09", "2006-11-11", "2006-11-23", "2006-12-25",
  # 2007
  "2007-01-01", "2007-01-15", "2007-02-19", "2007-05-28", "2007-07-04",
  "2007-09-03", "2007-10-08", "2007-11-11", "2007-11-22", "2007-12-25",
  # 2008
  "2008-01-01", "2008-01-21", "2008-02-18", "2008-05-26", "2008-07-04",
  "2008-09-01", "2008-10-13", "2008-11-11", "2008-11-27", "2008-12-25",
  # 2009
  "2009-01-01", "2009-01-19", "2009-02-16", "2009-05-25", "2009-07-04",
  "2009-09-07", "2009-10-12", "2009-11-11", "2009-11-26", "2009-12-25",
  # 2010
  "2010-01-01", "2010-01-18", "2010-02-15", "2010-05-31", "2010-07-04",
  "2010-09-06", "2010-10-11", "2010-11-11", "2010-11-25", "2010-12-25",
  # 2011
  "2011-01-01", "2011-01-17", "2011-02-21", "2011-05-30", "2011-07-04",
  "2011-09-05", "2011-10-10", "2011-11-11", "2011-11-24", "2011-12-25",
  # 2012
  "2012-01-01", "2012-01-16", "2012-02-20", "2012-05-28", "2012-07-04",
  "2012-09-03", "2012-10-08", "2012-11-11", "2012-11-22", "2012-12-25",
  # 2013
  "2013-01-01", "2013-01-21", "2013-02-18", "2013-05-27", "2013-07-04",
  "2013-09-02", "2013-10-14", "2013-11-11", "2013-11-28", "2013-12-25",
  # 2014
  "2014-01-01", "2014-01-20", "2014-02-17", "2014-05-26", "2014-07-04",
  "2014-09-01", "2014-10-13", "2014-11-11", "2014-11-27", "2014-12-25",
  # 2015
  "2015-01-01", "2015-01-19", "2015-02-16", "2015-05-25", "2015-07-04",
  "2015-09-07", "2015-10-12", "2015-11-11", "2015-11-26", "2015-12-25",
  # 2016
  "2016-01-01", "2016-01-18", "2016-02-15", "2016-05-30", "2016-07-04",
  "2016-09-05", "2016-10-10", "2016-11-11", "2016-11-24", "2016-12-25",
  # 2017
  "2017-01-01", "2017-01-16", "2017-02-20", "2017-05-29", "2017-07-04",
  "2017-09-04", "2017-10-09", "2017-11-11", "2017-11-23", "2017-12-25",
  # 2018
  "2018-01-01", "2018-01-15", "2018-02-19", "2018-05-28", "2018-07-04",
  "2018-09-03", "2018-10-08", "2018-11-11", "2018-11-22", "2018-12-25",
  # 2019
  "2019-01-01", "2019-01-21", "2019-02-18", "2019-05-27", "2019-07-04",
  "2019-09-02", "2019-10-14", "2019-11-11", "2019-11-28", "2019-12-25",
  # 2020
  "2020-01-01", "2020-01-20", "2020-02-17", "2020-05-25", "2020-07-04",
  "2020-09-07", "2020-10-12", "2020-11-11", "2020-11-26", "2020-12-25",
  # 2021
  "2021-01-01", "2021-01-18", "2021-02-15", "2021-05-31", "2021-07-04",
  "2021-09-06", "2021-10-11", "2021-11-11", "2021-11-25", "2021-12-25"
))


```


```{r}
# selecting deaths with overdose as a first, second, or third cause of death for 2014 - 2021

names(death_data_new_2014)
dim(death_data_new_2014)
head(death_data_new_2014)

death_data_new_2014x = death_data_new_2014

death_data_new_2014 = death_data_new_2014x


library(dplyr)

# # Assuming death_data_new_2014 is your dataframe
# death_data_new_2014 <- death_data_new_2014 %>%
#   filter(ACMECOD %in% number_sequences |
#          COD1 %in% number_sequences |
#          COD2 %in% number_sequences |
#          COD3 %in% number_sequences)

# death_data_new_2014 <- death_data_new_2014 %>%
#   filter(ACMECOD %in% number_sequences |
#          COD1 %in% number_sequences |
#          COD2 %in% secondary_sequences |
#          COD3 %in% secondary_sequences)

death_data_new_2014 <- death_data_new_2014 %>%
  filter((ACMECOD %in% number_sequences | COD1 %in% number_sequences))


secondary_sequences <- c("T400", "T401", "T402", "T403", "T404", "T406")

death_data_new_2014 <- death_data_new_2014 %>%
  mutate(
    opioid_contributing = if_else(grepl(paste(secondary_sequences, collapse = "|"), COD2) | 
                                   grepl(paste(secondary_sequences, collapse = "|"), COD3), "yes", "no"),
    cocaine_contributing = if_else(grepl("T405", COD2) | grepl("T405", COD3), "yes", "no"),
    other_stimi_contributing = if_else(grepl("T436", COD2) | grepl("T436", COD3), "yes", "no")
  )


# death_data_new_2014 <- death_data_new_2014 %>%
#   mutate(
#     opioid_contributing = if_else(grepl(secondary_sequences, COD2) | grepl(secondary_sequences, COD3), "yes", "no"),
#     cocaine_contributing = if_else(grepl("T405", COD2) | grepl("T405", COD3), "yes", "no"),
#     other_stimi_contributing = if_else(grepl("T436", COD2) | grepl("T436", COD3), "yes", "no")
#   )


# death_data_new_2014 <- death_data_new_2014 %>%
#   filter(!(grepl("T405", COD2) | grepl("T405", COD3)))


# View the selected rows
head(death_data_new_2014, 2000)


```


```{r}
# selecting overdose deaths from 1999 - 2013 data

# using grepl to create a logical vector indicating if each row contains the sequences
matches_1999 <- grepl(paste(number_sequences, collapse = "|"), death_data_all_1999$ACMECOD)

# subset the death data frame to select rows that match the sequences
death_data_1999 <- death_data_all_1999[matches_1999, ]

# this shows about 20,000 overdose deaths between 2014 and 2021. 
dim(death_data_1999)
head(death_data_1999)



```


```{r}
# selecting deaths with overdose as a first, second, or third cause of death for 1999 - 2013

names(death_data_new_1999)
dim(death_data_new_1999)

# # Assuming death_data_new_2014 is your dataframe
# death_data_new_1999 <- death_data_new_1999 %>%
#   filter(ACMECOD %in% number_sequences |
#          COD1 %in% number_sequences |
#          COD2 %in% number_sequences |
#          COD3 %in% number_sequences)

# death_data_new_1999 <- death_data_new_1999 %>%
#   filter(ACMECOD %in% number_sequences |
#          COD1 %in% number_sequences |
#          COD2 %in% secondary_sequences |
#          COD3 %in% secondary_sequences)

# death_data_new_1999 <- death_data_new_1999 %>%
#   filter((ACMECOD %in% number_sequences | COD1 %in% number_sequences) &
#          (COD2 %in% secondary_sequences | COD3 %in% secondary_sequences))

death_data_new_1999 <- death_data_new_1999 %>%
  filter((ACMECOD %in% number_sequences | COD1 %in% number_sequences))

death_data_new_1999 <- death_data_new_1999 %>%
  mutate(
    opioid_contributing = if_else(grepl(paste(secondary_sequences, collapse = "|"), COD2) | 
                                   grepl(paste(secondary_sequences, collapse = "|"), COD3), "yes", "no"),
    cocaine_contributing = if_else(grepl("T405", COD2) | grepl("T405", COD3), "yes", "no"),
    other_stimi_contributing = if_else(grepl("T436", COD2) | grepl("T436", COD3), "yes", "no")
  )

# # remove deaths with cocaine as a contributing cause
# death_data_new_1999 <- death_data_new_1999 %>%
#   filter(!(grepl("T405", COD2) | grepl("T405", COD3)))

# remove deaths on federal holidays




# View the selected rows
names(death_data_new_1999)
```

```{r}
# counties 

# county mapping for 2014-2021 data
county_mapping_2014 <- c(
  "1" = "Alamance", "3" = "Alexander", "5" = "Alleghany", "7" = "Anson",
  "9" = "Ashe", "11" = "Avery", "13" = "Beaufort", "15" = "Bertie",
  "17" = "Bladen", "19" = "Brunswick", "21" = "Buncombe", "23" = "Burke",
  "25" = "Cabarrus", "27" = "Caldwell", "29" = "Camden", "31" = "Carteret",
  "33" = "Caswell", "35" = "Catawba", "37" = "Chatham", "39" = "Cherokee",
  "41" = "Chowan", "43" = "Clay", "45" = "Cleveland", "47" = "Columbus",
  "49" = "Craven", "51" = "Cumberland", "53" = "Currituck", "55" = "Dare",
  "57" = "Davidson", "59" = "Davie", "61" = "Duplin", "63" = "Durham",
  "65" = "Edgecombe", "67" = "Forsyth", "69" = "Franklin", "71" = "Gaston",
  "73" = "Gates", "75" = "Graham", "77" = "Granville", "79" = "Greene",
  "81" = "Guilford", "83" = "Halifax", "85" = "Harnett", "87" = "Haywood",
  "89" = "Henderson", "91" = "Hertford", "93" = "Hoke", "95" = "Hyde",
  "97" = "Iredell", "99" = "Jackson", "101" = "Johnston", "103" = "Jones",
  "105" = "Lee", "107" = "Lenoir", "109" = "Lincoln", "111" = "Macon",
  "113" = "Madison", "115" = "Martin", "117" = "McDowell", "119" = "Mecklenburg",
  "121" = "Mitchell", "123" = "Montgomery", "125" = "Moore", "127" = "Nash",
  "129" = "New Hanover", "131" = "Northampton", "133" = "Onslow", "135" = "Orange",
  "137" = "Pamlico", "139" = "Pasquotank", "141" = "Pender", "143" = "Perquimans",
  "145" = "Person", "147" = "Pitt", "149" = "Polk", "151" = "Randolph",
  "153" = "Richmond", "155" = "Robeson", "157" = "Rockingham", "159" = "Rowan",
  "161" = "Rutherford", "163" = "Sampson", "165" = "Scotland", "167" = "Stanly",
  "169" = "Stokes", "171" = "Surry", "173" = "Swain", "175" = "Transylvania",
  "177" = "Tyrrell", "179" = "Union", "181" = "Vance", "183" = "Wake",
  "185" = "Warren", "187" = "Washington", "189" = "Watauga", "191" = "Wayne",
  "193" = "Wilkes", "195" = "Wilson", "197" = "Yadkin", "199" = "Yancey"
)

# county mapping for 1999-2013 data
county_mapping_1999 <- c(
  "1" = "Alamance", "2" = "Alexander", "3" = "Alleghany", "4" = "Anson",
  "5" = "Ashe", "6" = "Avery", "7" = "Beaufort", "8" = "Bertie",
  "9" = "Bladen", "10" = "Brunswick", "11" = "Buncombe", "12" = "Burke",
  "13" = "Cabarrus", "14" = "Caldwell", "15" = "Camden", "16" = "Carteret",
  "17" = "Caswell", "18" = "Catawba", "19" = "Chatham", "20" = "Cherokee",
  "21" = "Chowan", "22" = "Clay", "23" = "Cleveland", "24" = "Columbus",
  "25" = "Craven", "26" = "Cumberland", "27" = "Currituck", "28" = "Dare",
  "29" = "Davidson", "30" = "Davie", "31" = "Duplin", "32" = "Durham",
  "33" = "Edgecombe", "34" = "Forsyth", "35" = "Franklin", "36" = "Gaston",
  "37" = "Gates", "38" = "Graham", "39" = "Granville", "40" = "Greene",
  "41" = "Guilford", "42" = "Halifax", "43" = "Harnett", "44" = "Haywood",
  "45" = "Henderson", "46" = "Hertford", "47" = "Hoke", "48" = "Hyde",
  "49" = "Iredell", "50" = "Jackson", "51" = "Johnston", "52" = "Jones",
  "53" = "Lee", "54" = "Lenoir", "55" = "Lincoln", "56" = "Macon",
  "57" = "Madison", "58" = "Martin", "59" = "McDowell", "60" = "Mecklenburg",
  "61" = "Mitchell", "62" = "Montgomery", "63" = "Moore", "64" = "Nash",
  "65" = "New Hanover", "66" = "Northampton", "67" = "Onslow", "68" = "Orange",
  "69" = "Pamlico", "70" = "Pasquotank", "71" = "Pender", "72" = "Perquimans",
  "73" = "Person", "74" = "Pitt", "75" = "Polk", "76" = "Randolph",
  "77" = "Richmond", "78" = "Robeson", "79" = "Rockingham", "80" = "Rowan",
  "81" = "Rutherford", "82" = "Sampson", "83" = "Scotland", "84" = "Stanly",
  "85" = "Stokes", "86" = "Surry", "87" = "Swain", "88" = "Transylvania",
  "89" = "Tyrrell", "90" = "Union", "91" = "Vance", "92" = "Wake",
  "93" = "Warren", "94" = "Washington", "95" = "Watauga", "96" = "Wayne",
  "97" = "Wilkes", "98" = "Wilson", "99" = "Yadkin", "100" = "Yancey"
)

```

```{r}
# # replacing the county code in the "COD" column with the county name
# death_data$county <- county_mapping_2014[as.character(death_data$COD)]
# death_data_1999$county <- county_mapping_1999[as.character(death_data_1999$COOCC)]

# repeat for the three cause of death data
death_data_new_2014$county <- county_mapping_2014[as.character(death_data_new_2014$COD)]
death_data_new_1999$county <- county_mapping_1999[as.character(death_data_new_1999$COOCC)]

```

```{r}
# creating GEOID column

# Create a mapping between county numbers and FIPS codes
county_fips_mapping_1999 <- c(
  "1" = "37001", "2" = "37003", "3" = "37005", "4" = "37007",
  "5" = "37009", "6" = "37011", "7" = "37013", "8" = "37015",
  "9" = "37017", "10" = "37019", "11" = "37021", "12" = "37023",
  "13" = "37025", "14" = "37027", "15" = "37029", "16" = "37031",
  "17" = "37033", "18" = "37035", "19" = "37037", "20" = "37039",
  "21" = "37041", "22" = "37043", "23" = "37045", "24" = "37047",
  "25" = "37049", "26" = "37051", "27" = "37053", "28" = "37055",
  "29" = "37057", "30" = "37059", "31" = "37061", "32" = "37063",
  "33" = "37065", "34" = "37067", "35" = "37069", "36" = "37071",
  "37" = "37073", "38" = "37075", "39" = "37077", "40" = "37079",
  "41" = "37081", "42" = "37083", "43" = "37085", "44" = "37087",
  "45" = "37089", "46" = "37091", "47" = "37093", "48" = "37095",
  "49" = "37097", "50" = "37099", "51" = "37101", "52" = "37103",
  "53" = "37105", "54" = "37107", "55" = "37109", "56" = "37111",
  "57" = "37113", "58" = "37115", "59" = "37117", "60" = "37119",
  "61" = "37121", "62" = "37123", "63" = "37125", "64" = "37127",
  "65" = "37129", "66" = "37131", "67" = "37133", "68" = "37135",
  "69" = "37137", "70" = "37139", "71" = "37141", "72" = "37143",
  "73" = "37145", "74" = "37147", "75" = "37149", "76" = "37151",
  "77" = "37153", "78" = "37155", "79" = "37157", "80" = "37159",
  "81" = "37161", "82" = "37163", "83" = "37165", "84" = "37167",
  "85" = "37169", "86" = "37171", "87" = "37173", "88" = "37175",
  "89" = "37177", "90" = "37179", "91" = "37181", "92" = "37183",
  "93" = "37185", "94" = "37187", "95" = "37189", "96" = "37191",
  "97" = "37193", "98" = "37195", "99" = "37197", "100" = "37199"
)


county_fips_mapping_2014 <- c(
  "1" = "37001", "3" = "37003", "5" = "37005", "7" = "37007", "9" = "37009",
  "11" = "37011", "13" = "37013", "15" = "37015", "17" = "37017", "19" = "37019",
  "21" = "37021", "23" = "37023", "25" = "37025", "27" = "37027", "29" = "37029",
  "31" = "37031", "33" = "37033", "35" = "37035", "37" = "37037", "39" = "37039",
  "41" = "37041", "43" = "37043", "45" = "37045", "47" = "37047", "49" = "37049",
  "51" = "37051", "53" = "37053", "55" = "37055", "57" = "37057", "59" = "37059",
  "61" = "37061", "63" = "37063", "65" = "37065", "67" = "37067", "69" = "37069",
  "71" = "37071", "73" = "37073", "75" = "37075", "77" = "37077", "79" = "37079",
  "81" = "37081", "83" = "37083", "85" = "37085", "87" = "37087", "89" = "37089",
  "91" = "37091", "93" = "37093", "95" = "37095", "97" = "37097", "99" = "37099",
  "101" = "37101", "103" = "37103", "105" = "37105", "107" = "37107", "109" = "37109",
  "111" = "37111", "113" = "37113", "115" = "37115", "117" = "37117", "119" = "37119",
  "121" = "37121", "123" = "37123", "125" = "37125", "127" = "37127", "129" = "37129",
  "131" = "37131", "133" = "37133", "135" = "37135", "137" = "37137", "139" = "37139",
  "141" = "37141", "143" = "37143", "145" = "37145", "147" = "37147", "149" = "37149",
  "151" = "37151", "153" = "37153", "155" = "37155", "157" = "37157", "159" = "37159",
  "161" = "37161", "163" = "37163", "165" = "37165", "167" = "37167", "169" = "37169",
  "171" = "37171", "173" = "37173", "175" = "37175", "177" = "37177", "179" = "37179",
  "181" = "37181", "183" = "37183", "185" = "37185", "187" = "37187", "189" = "37189",
  "191" = "37191", "193" = "37193", "195" = "37195", "197" = "37197", "199" = "37199"
)


```

```{r}
# # Add a new column "FIPS" to death_data
# death_data$GEOID <- county_fips_mapping_2014[as.character(death_data$COD)]
# death_data_1999$GEOID <- county_fips_mapping_1999[as.character(death_data_1999$COOCC)]
# 
# 
# # Remove columns "AGETYPE" and "COD" from the dataframe
# death_data <- subset(death_data, select = -c(AGETYPE, COD))
# death_data_1999 <- subset(death_data_1999, select = -c(AGECODE, COOCC))


# repeat for new data 
death_data_new_2014$GEOID <- county_fips_mapping_2014[as.character(death_data_new_2014$COD)]
death_data_new_1999$GEOID <- county_fips_mapping_1999[as.character(death_data_new_1999$COOCC)]
death_data_new_2014 <- subset(death_data_new_2014, select = -c(AGETYPE, COD))
death_data_new_1999 <- subset(death_data_new_1999, select = -c(AGECODE, COOCC))


```

```{r}
# converting the date column to a date object

add_leading_zero <- function(date_str) {
  if (nchar(date_str) == 7) {
    date_str <- paste0("0", date_str)
  }
  return(date_str)
}

# death_data$dthdate <- sapply(death_data$dthdate, add_leading_zero)
# death_data$dthdate = as.character(death_data$dthdate)
# death_data$dthdate = as.Date(death_data$dthdate, format = "%m%d%Y")
# 
# death_data_1999$DTHDATE <- sapply(death_data_1999$DTHDATE, add_leading_zero)
# death_data_1999$DTHDATE = as.character(death_data_1999$DTHDATE)
# death_data_1999$DTHDATE = as.Date(death_data_1999$DTHDATE, format = "%m%d%Y")
# 
# # Specify the file path where you want to save the .csv file
# file_path <- "/Users/annastouffer/Documents/Yale/Thesis/Death Data/NC Opioid Death Tables/NCOpioidDeaths1422.csv"  
# 
# # Save the data frame as a .csv file
# #write.csv(death_data, file = file_path, row.names = FALSE)
# 
# file_path2 <- "/Users/annastouffer/Documents/Yale/Thesis/Death Data/NC Opioid Death Tables/NCOpioidDeaths9913.csv"  
# 
# # Save the data frame as a .csv file
# #write.csv(death_data_1999, file = file_path2, row.names = FALSE)
# 
# # Replace "your_file_path" with the actual directory where you want to save the file.


# repeat for new data
death_data_new_2014$dthdate <- sapply(death_data_new_2014$dthdate, add_leading_zero)
death_data_new_2014$dthdate = as.character(death_data_new_2014$dthdate)
death_data_new_2014$dthdate = as.Date(death_data_new_2014$dthdate, format = "%m%d%Y")

death_data_new_1999$DTHDATE <- sapply(death_data_new_1999$DTHDATE, add_leading_zero)
death_data_new_1999$DTHDATE = as.character(death_data_new_1999$DTHDATE)
death_data_new_1999$DTHDATE = as.Date(death_data_new_1999$DTHDATE, format = "%m%d%Y")

file_path <- "/Users/annastouffer/Documents/Yale/Thesis/Death Data/NC Opioid Death Tables/NCOpioidDeaths1422new.csv"  

# Save the data frame as a .csv file
#write.csv(death_data_new_2014, file = file_path, row.names = FALSE)

file_path2 <- "/Users/annastouffer/Documents/Yale/Thesis/Death Data/NC Opioid Death Tables/NCOpioidDeaths9913new.csv"  

# Save the data frame as a .csv file
#write.csv(death_data_new_1999, file = file_path2, row.names = FALSE)
```

```{r}
# replacing race column numbers with race 


#Assuming your data frame is death_data_new_2014 and the column is raceethcomb
death_data_new_2014$raceethcomb <- factor(death_data_new_2014$raceethcomb, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9), labels = c(
  "White Single Race, Non-Hispanic",
  "Black or African American Single Race, Non-Hispanic",
  "American Indian or Alaska Native Single Race, Non-Hispanic",
  "Asian Single Race, Non-Hispanic",
  "Native Hawaiian Single Race, Non-Hispanic",
  "Multiple Race, Non-Hispanic",
  "Other Race, Single Race, Non-Hispanic",
  "Hispanic",
  "Unknown"
))



# Assuming your data frame is death_data_new_1999 and the column is RACE
death_data_new_1999$RACE <- factor(death_data_new_1999$RACE, levels = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9), labels = c(
  "Other non-White", "White", "Black", "American Indian", "Chinese", "Japanese", "Hawaiian", "Filipino", "Other Asian", "Unknown"
))

# creating hispanic column for 2014-2021 data 

# Assuming your data frame is death_data_new_2014
death_data_new_2014 <- death_data_new_2014 %>%
  mutate(Ethnicity = ifelse(raceethcomb == "Hispanic", "Y", "N"))

# replacing integer sex with letter sex
death_data_new_1999 <- death_data_new_1999 %>%
  mutate(sex = factor(SEX, levels = c(1, 2), labels = c("M", "F")))

```

```{r}
# creating a dataframe of all opioid deaths for the top three causes of death data

head(death_data_new_2014)
head(death_data_new_1999)

unique(death_data_new_2014$raceethcomb)
unique(death_data_new_1999$sex)


# creating a .csv file with death rates per county per year 

dim(death_data_new_2014)
dim(death_data_new_1999)

names(death_data_new_2014)
names(death_data_new_1999)

# Select and rename columns in each dataframe
death_data_new_2014 <- death_data_new_2014 %>%
  select(county, GEOID, AGE, raceethcomb, dthdate, SEX, Ethnicity, opioid_contributing, cocaine_contributing, other_stimi_contributing) %>%
  rename(
    county = county,
    GEOID = GEOID,
    age = AGE,
    race = raceethcomb,
    deathdate = dthdate,
    sex = SEX,
    ethnicity = Ethnicity, 
    opioid_contributing = opioid_contributing,
    cocaine_contributing = cocaine_contributing,
    other_stimi_contributing = other_stimi_contributing
  )

death_data_new_1999 <- death_data_new_1999 %>%
  select(county, GEOID, AGEUNITS, RACE, DTHDATE, sex, HISP, opioid_contributing, cocaine_contributing, other_stimi_contributing) %>%
  rename(
    county = county,
    GEOID = GEOID,
    age = AGEUNITS,
    race = RACE,
    deathdate = DTHDATE,
    sex = sex,
    ethnicity = HISP,
    opioid_contributing = opioid_contributing,
    cocaine_contributing = cocaine_contributing,
    other_stimi_contributing = other_stimi_contributing
  )

# Combine the dataframes
all_deaths <- bind_rows(death_data_new_2014, death_data_new_1999)

head(all_deaths, 1000)
dim(all_deaths)

all_deaths <- all_deaths %>%
  mutate(uniqueID = str_pad(row_number(), width = 6, pad = "0"))

all_deaths <- all_deaths %>%
  mutate(year = year(as.Date(deathdate)))

# removing deaths that fall on federal holidays
all_deaths <- all_deaths %>%
  mutate(deathdate = as.Date(deathdate)) %>%
  filter(!deathdate %in% holidays)



# Save the combined dataframe to a CSV file
#write.csv(all_deaths, "/Users/annastouffer/Documents/Yale/Thesis/Death Data/all_death_data_2022.csv", row.names = FALSE)

dim(all_deaths)

```

```{r}
# # creating a .csv file with death rates per county per year 
# 
# head(death_data)
# head(death_data_1999)
# dim(death_data)
# dim(death_data_1999)
# 
# names(death_data)
# names(death_data_1999)
# 
# # Select and rename columns in each dataframe
# death_data <- death_data %>%
#   select(county, GEOID, AGE, raceethcomb, dthdate) %>%
#   rename(
#     county = county,
#     GEOID = GEOID,
#     age = AGE,
#     race = raceethcomb,
#     deathdate = dthdate
#   )
# 
# death_data_1999 <- death_data_1999 %>%
#   select(county, GEOID, AGEUNITS, RACE, DTHDATE) %>%
#   rename(
#     county = county,
#     GEOID = GEOID,
#     age = AGEUNITS,
#     race = RACE,
#     deathdate = DTHDATE
#   )
# 
# # Combine the dataframes
# all_deaths <- bind_rows(death_data, death_data_1999)
# 
# # Save the combined dataframe to a CSV file
# #write.csv(all_deaths, "/Users/annastouffer/Documents/Yale/Thesis/Death Data/combined_death_data.csv", row.names = FALSE)
# 
# # creating a dataframe with counties and number of deaths per county per year
# 
# # Step 1: Extract the year from the "deathdate" column
# all_deaths$year <- as.integer(format(all_deaths$deathdate, "%Y"))
# 
# # Step 2: Calculate annual death counts per county and year
# annual_deaths <- all_deaths %>%
#   group_by(county, year) %>%
#   summarise(deaths = n()) %>%
#   ungroup()
# 
# # Step 3: Create a new dataframe with counties as rows and years as columns
# unique_years <- sort(unique(annual_deaths$year))
# unique_counties <- unique(annual_deaths$county)
# 
# # Create an empty dataframe
# county_year_deaths <- data.frame(county = unique_counties)
# 
# # ... (previous code)
# 
# # Create an empty dataframe with county names
# county_year_deaths <- data.frame(county = unique_counties)
# 
# # Now, reshape the data
# county_year_deaths <- annual_deaths %>%
#   pivot_wider(names_from = year, values_from = deaths, values_fill = 0)
# 
# head(county_year_deaths, 100)
# 
# # Now 'county_year_deaths' contains counties as rows and years as columns with death counts
# #write.csv(county_year_deaths, "/Users/annastouffer/Documents/Yale/Thesis/Death Data/deaths_per_county_per_year.csv", row.names = FALSE)
# 
# # Now county_year_deaths is the desired dataframe with counties as rows and years as columns
```

```{r}
# population data 
# from https://www.osbm.nc.gov/facts-figures/population-demographics/state-demographer/county-population-estimates/county-population-estimates

population_data = read.csv("/Users/annastouffer/Documents/Yale/Thesis/Death Data/NCprojectionsbyage2022.csv")

head(population_data)


result <- population_data %>%
  group_by(year, county, fips) %>%
  summarize(total_population = sum(total))

head(result)


#write.csv(result, "/Users/annastouffer/Documents/Yale/Thesis/Death Data/population_per_county_per_year.csv", row.names = FALSE)

# Calculate the total population for each year and county


```

```{r}
# trying ACS...don't think this method will work

# Define your API key (you need to get your own API key from the U.S. Census Bureau)
census_api_key("d2bf4e425f145a0f6c90f045163548e4a295b648", install = TRUE, overwrite = TRUE)

# Specify the variables you want (P001001 is the code for total population)
variables <- c("P001001")

# # Get population data for North Carolina counties for the years 2000-2021
# nc_pop_data <- get_acs(
#   geography = "county",
#   variables = variables,
#   state = 37,
#   survey = "1-year",
#   years = 2000:2021
# )

 county_map <- get_decennial(
    geography = "county",
    variables = c("Total_pop" = "P001001"),
    year = 2010,
    output = "wide",
    geometry = TRUE,
    state = 37)
 
 head(census_data)
 
 
 county_map <- counties(state = "NC")



```


```{r}
# trends for each county 

dim(death_trends_2014_data)

# Create a summary table with death counts per year and county
death_trends_2014_data <- all_deaths %>%
  group_by(Year = year(deathdate), county, GEOID) %>%
  summarise(Deaths = n())

death_trends_2014_data <- death_trends_2014_data %>%
  left_join(county_map %>% select(GEOID, Total_pop), by = "GEOID")

death_trends_2014_data$death_rate = (death_trends_2014_data$Deaths / death_trends_2014_data$Total_pop) * 100000

head(death_trends_2014_data)

ggplot(death_trends_2014_data, aes(x = Year, y = death_rate, color = county)) +
  geom_line() +
  labs(title = "Death Rate Trends per County (2014-2021)",
       x = "Year",
       y = "Number of Deaths") +
  theme_minimal() +
  theme(legend.position = "bottom")  # Adjust legend position as needed


ggplot(death_trends_2014_data, aes(x = Year, y = death_rate, color = county)) +
  geom_line() +
  labs(title = "Death Rate Trends per County (2014-2021)",
       x = "Year",
       y = "Number of Deaths") +
  theme_minimal() +
  guides(color = "none")  # Hide the legend


plot_ly(data = death_trends_2014_data, x = ~Year, y = ~death_rate, color = ~county) %>%
  add_lines() %>%
  layout(title = "Death Rate Trends by County (2014-2021)",
         xaxis = list(title = "Year"),
         yaxis = list(title = "Number of Deaths"),
         showlegend = TRUE)  # Hide the legend
```


```{r}

death_trends_year <- all_deaths %>%
  group_by(Year = year(deathdate)) %>%
  summarise(Deaths = n())

# death_trends_year_1999 = death_data_1999 %>%
#   group_by(Year = year(DTHDATE)) %>%
#   summarise(Deaths = n())

dim(death_trends_year_1999)
dim(death_trends_year)

combined_data = bind_rows(death_trends_year, death_trends_year_1999)

ggplot(death_trends_year, aes(x = Year, y = Deaths)) +
  geom_line() +
  labs(title = "Number of Opioid Overdose Deaths in NC (1999-2021)",
       x = "Year",
       y = "Number of Deaths") +
  theme_minimal() +
  theme(legend.position = "bottom")  # Adjust l

```



############# PLOTS ###################

```{r}
# visualizing county representiation 2014 - 2021

# only 51 counties are represented as containing overdose deaths between 2014 and 2021
length(unique(death_data$county))

# counting deaths per county
county_counts <- table(all_deaths$county)

# creating a dataframe of death counts per county
county_counts_df <- data.frame(County = names(county_counts), Count = as.numeric(county_counts))

ggplot(county_counts_df, aes(x = reorder(County, -Count), y = Count)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(x = "County", y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("County Representation in Data")


```

```{r}

# visualizing county representiation 1999 - 2013

# only 51 counties are represented as containing overdose deaths between 2014 and 2021
length(unique(death_data_1999$county))

# counting deaths per county
county_counts <- table(death_data_1999$county)

# creating a dataframe of death counts per county
county_counts_df <- data.frame(County = names(county_counts), Count = as.numeric(county_counts))

ggplot(county_counts_df, aes(x = reorder(County, -Count), y = Count)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(x = "County", y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("County Representation in Data")


```

```{r}
# plotting death on a map of north carolina 2014 - 2021

# getting the NC shapefile
get_acs_decennial <- function(geography){
  acs_year <- get_decennial(
    geography = geography,
    variables = c("Total_pop" = "P001001",
                  "White" = "P005003",
                  "Black" = "P005004",
                  "Asian" = "P005006",
                  "Hispanic" = "P005010"),
    year = 2010,
    output = "wide",
    geometry = TRUE,
    state = 37
  ) %>%
    st_transform(crs = st_crs(4326)) %>%
    filter(!st_is_empty(.)) %>%
    mutate(Other = Total_pop - White - Black - Asian - Hispanic)
  return(acs_year)
}

county_map <- get_acs_decennial("county")

# getting rid of the demographics columns here
county_map <- subset(county_map, select = -c(Total_pop, White, Black, Asian, Hispanic, Other))

# merging with death data based on GEOID
nc_counties <- merge(county_map, all_deaths, by = "GEOID")

# calculating the row counts for each county
county_row_counts <- as.data.frame(table(nc_counties$GEOID))

# merging the row counts with the county geometries
nc_counties <- merge(nc_counties, county_row_counts, by.x = "GEOID", by.y = "Var1", all.x = TRUE)

head(nc_counties)

# plot
ggplot() +
  geom_sf(data = nc_counties, aes(fill = Freq), color = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Row Count") +
  labs(title = "North Carolina Counties by Row Count") +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# Convert deathdate to year
nc_counties$year <- format(nc_counties$deathdate, "%Y")

# Filter data for each time period
data_2000_2021 <- nc_counties
data_2000_2021 <- filter(data_2000_2021, year >= 2000 & year <= 2021)

data_2000_2010 <- nc_counties
data_2000_2010 <- filter(data_2000_2010, year >= 2000 & year <= 2010)

data_2010_2013 <- nc_counties
data_2010_2013 <- filter(data_2010_2013, year >= 2010 & year <= 2013)

data_2013_2018 <- nc_counties
data_2013_2018 <- filter(data_2013_2018, year >= 2013 & year <= 2018)

data_2018_2021 <- nc_counties
data_2018_2021 <- filter(data_2018_2021, year >= 2018 & year <= 2021)

# Create plots for each time period
plot_2000_2021 <- ggplot() +
  geom_sf(data = data_2000_2021, aes(fill = Freq), color = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Row Count") +
  labs(title = "Overall (2000-2021)") +
  theme_minimal() +
  theme(legend.position = "bottom")

plot_2000_2010 <- ggplot() +
  geom_sf(data = data_2000_2010, aes(fill = Freq), color = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Row Count") +
  labs(title = "Wave 1 (2000-2010)") +
  theme_minimal() +
  theme(legend.position = "bottom")

plot_2010_2013 <- ggplot() +
  geom_sf(data = data_2010_2013, aes(fill = Freq), color = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Row Count") +
  labs(title = "Wave 2 (2010-2013)") +
  theme_minimal() +
  theme(legend.position = "bottom")

plot_2013_2018 <- ggplot() +
  geom_sf(data = data_2013_2018, aes(fill = Freq), color = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Row Count") +
  labs(title = "Wave 3 (2013-2018)") +
  theme_minimal() +
  theme(legend.position = "bottom")

plot_2018_2021 <- ggplot() +
  geom_sf(data = data_2018_2021, aes(fill = Freq), color = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Row Count") +
  labs(title = "Wave 4 (2018-2021)") +
  theme_minimal() +
  theme(legend.position = "bottom")

#install.packages("patchwork")
library(patchwork)

# Arrange plots horizontally
all_plots <- plot_2000_2021 + plot_2000_2010 + plot_2010_2013 + plot_2013_2018 + plot_2018_2021

# Print the combined plot
all_plots





```

```{r}
# plotting death rate on a map of north carolina 2014 - 2021

# getting the NC shapefile
get_acs_decennial <- function(geography){
  acs_year <- get_decennial(
    geography = geography,
    variables = c("Total_pop" = "P001001",
                  "White" = "P005003",
                  "Black" = "P005004",
                  "Asian" = "P005006",
                  "Hispanic" = "P005010"),
    year = 2010,
    output = "wide",
    geometry = TRUE,
    state = 37
  ) %>%
    st_transform(crs = st_crs(4326)) %>%
    filter(!st_is_empty(.)) %>%
    mutate(Other = Total_pop - White - Black - Asian - Hispanic)
  return(acs_year)
}

county_map <- get_acs_decennial("county")

# getting rid of the demographics columns here
county_map <- subset(county_map, select = -c(White, Black, Asian, Hispanic, Other))

# merging with death data based on GEOID
nc_counties <- merge(county_map, death_data, by = "GEOID")

head(nc_counties)

# calculating the row counts for each county
county_row_counts <- as.data.frame(table(nc_counties$GEOID))

county_row_counts$GEOID = county_row_counts$Var1

county_row_counts <- county_row_counts %>%
  left_join(county_map %>% select(GEOID, Total_pop), by = "GEOID")

county_row_counts$death_rate = (county_row_counts$Freq/county_row_counts$Total_pop) * 100000

head(county_row_counts)

nc_counties <- left_join(nc_counties, county_row_counts, by = "GEOID")

dim(nc_counties)

# plot
ggplot() +
  geom_sf(data = nc_counties, aes(fill = death_rate), color = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Row Count") +
  labs(title = "Overdose Death Rate per 100,000 People 2014 - 2021 Aggregate") +
  theme_minimal() +
  theme(legend.position = "bottom")



```


```{r}

# plotting death rate on a map of north carolina 2014 - 2021 LOOP

# getting the NC shapefile
get_acs_decennial <- function(geography){
  acs_year <- get_decennial(
    geography = geography,
    variables = c("Total_pop" = "P001001",
                  "White" = "P005003",
                  "Black" = "P005004",
                  "Asian" = "P005006",
                  "Hispanic" = "P005010"),
    year = 2010,
    output = "wide",
    geometry = TRUE,
    state = 37
  ) %>%
    st_transform(crs = st_crs(4326)) %>%
    filter(!st_is_empty(.)) %>%
    mutate(Other = Total_pop - White - Black - Asian - Hispanic)
  return(acs_year)
}

county_map <- get_acs_decennial("county")


# getting rid of the demographics columns here
county_map <- subset(county_map, select = -c(White, Black, Asian, Hispanic, Other))


for (year in 2014:2021) {

#head(death_data)
#class(death_data$dthdate)
  
death_data_year <- subset(death_data, year(death_data$dthdate) == year)
  
#death_data_year <- death_data[as.numeric(format(death_data$dthdate, "%Y")) == year, ]

#head(death_data_year)

#unique(year(death_data$dthdate))


# merging with death data based on GEOID
nc_counties <- merge(county_map, death_data_year, by = "GEOID")

# calculating the row counts for each county
county_row_counts <- as.data.frame(table(nc_counties$GEOID))

county_row_counts$GEOID = county_row_counts$Var1

county_row_counts <- county_row_counts %>%
  left_join(county_map %>% select(GEOID, Total_pop), by = "GEOID")

county_row_counts$death_rate = (county_row_counts$Freq/county_row_counts$Total_pop) * 100000

head(county_row_counts)

nc_counties <- left_join(nc_counties, county_row_counts, by = "GEOID")

dim(nc_counties)

# plot
plot = ggplot() +
  geom_sf(data = nc_counties, aes(fill = death_rate), color = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Row Count", limits = c(0, 100)) +
  labs(title = paste("Overdose Death Rate per 100,000 people", year)) +
  theme_minimal() +
  theme(legend.position = "bottom")

#file_name <- paste("/Users/annastouffer/Documents/Yale/Thesis/Death Data/NC Death Rate Plots/plot_", year, ".png", sep = "")
#ggsave(file_name, plot, width = 6, height = 4, dpi = 300)

print(plot)
}


```

```{r}


# plotting death rate on a map of north carolina 1999 - 2013 LOOP

# getting the NC shapefile
get_acs_decennial <- function(geography){
  acs_year <- get_decennial(
    geography = geography,
    variables = c("Total_pop" = "P001001",
                  "White" = "P005003",
                  "Black" = "P005004",
                  "Asian" = "P005006",
                  "Hispanic" = "P005010"),
    year = 2010,
    output = "wide",
    geometry = TRUE,
    state = 37
  ) %>%
    st_transform(crs = st_crs(4326)) %>%
    filter(!st_is_empty(.)) %>%
    mutate(Other = Total_pop - White - Black - Asian - Hispanic)
  return(acs_year)
}

county_map <- get_acs_decennial("county")


# getting rid of the demographics columns here
county_map <- subset(county_map, select = -c(White, Black, Asian, Hispanic, Other))


for (year in 1999:2013) {

#head(death_data)
#class(death_data$dthdate)
  
death_data_year <- subset(death_data_1999, year(death_data_1999$DTHDATE) == year)
  
#death_data_year <- death_data[as.numeric(format(death_data$dthdate, "%Y")) == year, ]

#head(death_data_year)

#unique(year(death_data$dthdate))


# merging with death data based on GEOID
nc_counties <- merge(county_map, death_data_year, by = "GEOID")

# calculating the row counts for each county
county_row_counts <- as.data.frame(table(nc_counties$GEOID))

county_row_counts$GEOID = county_row_counts$Var1

county_row_counts <- county_row_counts %>%
  left_join(county_map %>% select(GEOID, Total_pop), by = "GEOID")

county_row_counts$death_rate = (county_row_counts$Freq/county_row_counts$Total_pop) * 100000

head(county_row_counts)

nc_counties <- left_join(nc_counties, county_row_counts, by = "GEOID")

dim(nc_counties)

# plot
plot = ggplot() +
  geom_sf(data = nc_counties, aes(fill = death_rate), color = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Row Count", limits = c(0, 100)) +
  labs(title = paste("Overdose Death Rate per 100,000 people", year)) +
  theme_minimal() +
  theme(legend.position = "bottom")

#file_name <- paste("/Users/annastouffer/Documents/Yale/Thesis/Death Data/NC Death Rate Plots/plot_", year, ".png", sep = "")
#ggsave(file_name, plot, width = 6, height = 4, dpi = 300)


print(plot)
}


head(nc_counties, 100)
```